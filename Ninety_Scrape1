# Ninety Srape 1 - Scraping from Ninety's Folders
#Here we will scrape text from various document formats and compile them into a structured dataset
import os
import pandas as pd 

from docx import Document
from PyPDF2 import PdfReader
from pptx import Presentation
import xlrd
import openpyxl

def extract_text(filepath):
    ext = filepath.lower().split('.')[-1]
    text = ''
    try:
        if ext == 'pdf':
            reader = PdfReader(filepath)
            for page in reader.pages:
                page_text = page.extract_text()
                if page_text:
                    text += page_text + '\n'
        elif ext == 'docx':
            doc = Document(filepath)
            for para in doc.paragraphs:
                text += para.text + '\n'
        elif ext == 'pptx':
            pres = Presentation(filepath)
            for slide in pres.slides:
                for shape in slide.shapes:
                    if hasattr(shape, "text"):
                        text += shape.text + '\n'
        elif ext == 'xls':
            wb = xlrd.open_workbook(filepath)
            for sheet in wb.sheets():
                for row in range(sheet.nrows):
                    text += ' '.join([str(cell) for cell in sheet.row_values(row)]) + '\n'
        elif ext == 'xlsx':
            wb = openpyxl.load_workbook(filepath, data_only=True)
            for sheet in wb.worksheets:
                for row in sheet.iter_rows(values_only=True):
                    row_text = ' '.join([str(cell) for cell in row if cell is not None])
                    text += row_text + '\n'
    except Exception as e:
        text = f'Error extracting: {e}'
    return text

root_folder = '/Users/beatricesoresina/Library/CloudStorage/OneDrive-UniversityCollegeLondon/Academic/UCL/Year 4/Ninety/Consulting Clients'

data = []
for r, d, f in os.walk(root_folder):
    for file in f:
        if file.endswith(('.pdf', '.docx', '.pptx', '.xls', '.xlsx')):
            full_path = os.path.join(r, file)
            print(f'Processing: {file}')
            text = extract_text(full_path)
            # Remove the root_folder prefix from the file_path
            relative_path = os.path.relpath(full_path, root_folder)
            # Extract company name (first folder after Consulting Clients)
            path_parts = relative_path.split(os.sep)
            company_name = path_parts[0] if path_parts else 'Unknown'
            data.append({
                'company_name': company_name,
                'file_name': file,
                'file_path': relative_path,
                'scraped_text': text
            })

df = pd.DataFrame(data)
print(df.head())

df = pd.DataFrame(data)
print(df.head())

output_dir = '/Users/beatricesoresina/Library/CloudStorage/OneDrive-UniversityCollegeLondon/Academic/UCL/Year 4/Ninety'

df.to_excel(os.path.join(output_dir, 'output.xlsx'), index=False)

df.to_csv(os.path.join(output_dir, 'output.csv'), index=False)

print(f"Files saved to: {output_dir}")
